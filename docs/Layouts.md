
# Макеты (Layouts). SimpleMVC
## Назначение макетов

Макеты (иногда их также называют Шаблонами) нужны, чтобы  избежать повторения в коде каждого файла [представления](Views.md) тех частей, которые являются _общими_ для многих  страниц  на сайте, т.е. таких блоков как:
* хэдер
* футер
* меню
* и др.

Т.е. макет позволяет _не дублировать код_ одинаковых частей, которые есть у разных страниц сайта.

## Как работает подсистема макетов

Работа подсистемы Ядра отвечающей за использование макета  в основном сосредоточена в реализации метода `View->render()` (см. [исх. код класса View](https://github.com/it-for-free/SimpleMVC/blob/master/src/mvc/View.php#L1), ранее мы упоминали этот метод в разделе ["Представления"](Views.md)).

Т.е. в момент, когда в [действии контроллера](Controllers.md) выполняется код вида:
```php
$this->view->render('путь/к/файлу/предстваления');
```
запускается реализация метода `View->render()`:
```php
public function render($viewFilePath, $layoutPath = '')
{
    if($layoutPath) {
        $layoutPath = $this->layoutsBasePath . $layoutPath; 
    } else {
        $layoutPath = $this->layoutPath;
    }
    
    // Далее начинаем формировать представление
    extract($this->vars); // распаковываем переменные, переданные в представление (VIEW)
    
    ob_start(); // перехватываем поток вывода
    include($this->templateBasepath . $viewFilePath); 
    $CONTENT_DATA = ob_get_contents(); // записываем перехваченное в переменную
    ob_end_clean(); // отключаем перехват
    
    include($layoutPath); // подключаем макет, куда и будет подставлено 
}
```
-- где фактически происходит следующее:
  
  * Сначала определяется _какой именно путь к файлу макета_ нужно использовать (путь по умолучанию устанавливается в конструктре данного класса и берется из [конфига](Config.md)), после чего это путь записывается в переменную `$layoutPath`.
  * Далее с помощью стандатрной функции extract() в область видимости _разворачиваются переменные_, ранее переданные в Представление вызовом [addVar() в контроллере](Views.md).
  * После чего наступает наиболее интересная стадия, с помощью кода:
```php
ob_start(); // перехватываем поток вывода
include($this->templateBasepath . $viewFilePath); 
// записываем перехваченное в переменную
$CONTENT_DATA = ob_get_contents(); 
ob_end_clean(); // отключаем перехват
```
мы складываем, все что направлялось в стадартный [поток вывода](http://fkn.ktu10.com/?q=node/12190) -- т.е.:
* начиная с вызова [ob_start()](https://www.php.net/manual/ru/function.ob-start.php), весь html из файлов представления а также все результаты работы функции `echo()` не выводятся сразу на экран, а накапливается в специальной области памяти (буфере).
* Накопленные данные извлекаются из буфера вызовом [ob_get_contents()](https://www.php.net/manual/ru/function.ob-get-contents.php) и записываются в переменную `$CONTENT_DATA`.
* Буферизация вывода отлючается вызовом функции [ob_end_clean()](https://www.php.net/manual/ru/function.ob-end-clean.php);
* Затем делается включение файл макета:
```php
include($layoutPath); 
```

Далее рассмотрим пример файла макете и увидим как именно файл макета должен использовать данные, накопленные в `$CONTENT_DATA`

## Файл макета

В качестве пример рассмотрим код макета основного файла макета `main.php` ([исх. код](https://github.com/it-for-free/SimpleMVC-example/blob/master/application/views/layouts/main.php#L1)):
```php
<!DOCTYPE html>
<html>
    <?php include('includes/main/head.php'); ?>
    <body> 
        <?php include('includes/main/nav.php'); ?>
        <div class="container">
            <?= $CONTENT_DATA ?>
        </div>
        <?php include('includes/main/footer.php'); ?>
    </body>
</html>
```
-- здесь мы фактически видим основу тела html страницы, куда подключаются разные части и в том числе выводятся данные полученные в Представлении:
```php
<?= $CONTENT_DATA ?>
```

## Где определяется какой макет будет использоваться

Имя (путь к файлу) используемого макета определяется сразу для всех действий [Контроллера](Controllers.md) в свойстве класса контроллера `$layoutPath`.

## Как создать собственный макет

Чтобы создать собственный макет и подключить его к [контроллеру](Controllers.md), действуйте так:
1. Где-нибудь внутри (можно в поддиректории) директории `application/views/layouts/` (или иной, все зависит от того, что указано в [конфиге](Confing.md)) Создайте основной файл вашего макета (тот который будет выводить `$CONTENT_DATA` и подключать другие части страницы, по аналогии с тем как это делает стандатрный [main.php](https://github.com/it-for-free/SimpleMVC-example/blob/master/application/views/layouts/main.php#L1).
2. Укажите путь к этому макету в `$layoutPath` вашего контроллера.
3. Готово! Все действия контроллера будут при вызове `$this->view->render()` использовать ваш новый макет.

## Итоги

* Система макетов позволяет _переиспользовать_ общие части внешнего вида (такие как хэдер и футер) для разных файлов представлений.
* Файл макета должен (иначе какой смысл его описывать) обращаться к переменной `$CONTENT_DATA` и также может делать включения (а может и не делать, если выхотите все описать прямо в нем же) других нужных ему частей.
* Чтобы указать какой файл макета использовать контроллеру используется свойство контроллера `$layoutPath`.






